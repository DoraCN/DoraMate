# 08 - å¯è§†åŒ–ç¼–è¾‘å™¨è§„åˆ’

> **æ ¸å¿ƒå†…å®¹**: Leptos ç»„ä»¶æ¶æ„ã€SVG ç”»å¸ƒå®ç°ã€äº¤äº’è®¾è®¡ã€èŠ‚ç‚¹ç¼–è¾‘å™¨
>
> **â­ v4.0 æ›´æ–°è¯´æ˜**: æœ¬æ–‡æ¡£æè¿° DoraMate å¯è§†åŒ–ç¼–è¾‘å™¨çš„å®Œæ•´è§„åˆ’ï¼Œé‡‡ç”¨ **Leptos + SVG** æŠ€æœ¯æ ˆï¼Œå®ç°é«˜æ€§èƒ½èŠ‚ç‚¹ç¼–è¾‘å™¨ã€‚ä¸ Blazor ç‰ˆæœ¬ä¸åŒï¼Œæœ¬ç‰ˆæœ¬ä½¿ç”¨ WebAssembly åŸç”Ÿæ€§èƒ½ã€ç»†ç²’åº¦å“åº”å¼æ›´æ–°ã€‚
>
> **âš ï¸ å½“å‰å®ç°çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ âœ… | é«˜çº§åŠŸèƒ½ ğŸš§

---

## ğŸ¯ 8.0 è®¾è®¡ç›®æ ‡ä¸åŸåˆ™

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**æ‰€è§å³æ‰€å¾— (WYSIWYG)**

DoraMate å¯è§†åŒ–ç¼–è¾‘å™¨éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **ç›´è§‚æ€§** - æ‹–æ‹½å¼æ“ä½œï¼Œæ— éœ€ç¼–ç¨‹
2. **å®æ—¶åé¦ˆ** - æ‰€æœ‰æ“ä½œç«‹å³ç”Ÿæ•ˆ
3. **é«˜æ€§èƒ½** - 60fps æµç•…è¿è¡Œï¼Œæ”¯æŒ 50+ èŠ‚ç‚¹
4. **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œé›¶è¿è¡Œæ—¶é”™è¯¯
5. **å¯æ‰©å±•** - æ’ä»¶åŒ–èŠ‚ç‚¹ç³»ç»Ÿ

### ä¸ºä»€ä¹ˆé€‰æ‹© Leptos + SVGï¼Ÿ

**æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**:

| ç»´åº¦ | Leptos + SVG | React + Canvas | Blazor + SVG | é€‰æ‹© |
|-----|-------------|----------------|--------------|------|
| **æ€§èƒ½** | â­â­â­â­â­ (ç»†ç²’åº¦æ›´æ–°) | â­â­â­â­ (è™šæ‹Ÿ DOM) | â­â­â­ (Diff å¼€é”€) | **Leptos** |
| **ç±»å‹å®‰å…¨** | â­â­â­â­â­ (ç¼–è¯‘æ—¶) | â­â­â­ (è¿è¡Œæ—¶) | â­â­â­â­â­ (ç¼–è¯‘æ—¶) | **Rust** |
| **åŒ…ä½“ç§¯** | â­â­â­â­â­ (~100KB) | â­â­â­ (~300KB) | â­â­ (~2MB) | **Leptos** |
| **å­¦ä¹ æ›²çº¿** | â­â­â­ (éœ€å­¦ä¹  Rust) | â­â­â­â­ (ç†Ÿæ‚‰ JS) | â­â­â­â­â­ (æ‚¨ç†Ÿæ‚‰) | **Blazor** |
| **ç”Ÿæ€æˆç†Ÿåº¦** | â­â­â­ (å¿«é€Ÿæˆé•¿) | â­â­â­â­â­ (éå¸¸æˆç†Ÿ) | â­â­â­â­ (æˆç†Ÿ) | **React** |
| **é•¿æœŸä»·å€¼** | â­â­â­â­â­ (å¯å¤ç”¨ç»„ä»¶) | â­â­â­ (ä»…æœ¬ç³»ç»Ÿ) | â­â­â­ (ä»…æœ¬ç³»ç»Ÿ) | **Leptos** |

**é€‰æ‹© Leptos + SVG çš„ç†ç”±**:
- âœ… **ç»†ç²’åº¦å“åº”å¼** - åªæ›´æ–°å˜åŒ–çš„èŠ‚ç‚¹ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªç”»å¸ƒ
- âœ… **WebAssembly åŸç”Ÿ** - æ¥è¿‘åŸç”Ÿåº”ç”¨çš„æ€§èƒ½
- âœ… **SVG çŸ¢é‡å›¾å½¢** - æ— é™ç¼©æ”¾ä¸å¤±çœŸï¼Œæ˜“äºå®ç°è´å¡å°”æ›²çº¿
- âœ… **ç±»å‹å®‰å…¨** - Rust ç¼–è¯‘å™¨ä¿è¯ä»£ç è´¨é‡
- âœ… **é•¿æœŸä»·å€¼** - æ„å»ºå¯å¤ç”¨ UI ç»„ä»¶åº“

---

## ğŸ—ï¸ 8.1 æ¶æ„æ€»è§ˆ

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
App (ä¸»åº”ç”¨)
â”œâ”€â”€ FileLoader (å·¥å…·æ ) âœ…
â”‚   â”œâ”€â”€ æ–‡ä»¶åŠ è½½/ä¿å­˜
â”‚   â”œâ”€â”€ æœ€è¿‘æ–‡ä»¶èœå•
â”‚   â””â”€â”€ æœ¬åœ°è¿è¡ŒæŒ‰é’®
â”‚
â”œâ”€â”€ NodePanel (èŠ‚ç‚¹é¢æ¿) âœ…
â”‚   â”œâ”€â”€ åˆ†ç±»æ ‡ç­¾ (è¾“å…¥/å¤„ç†/è¾“å‡º/è‡ªå®šä¹‰)
â”‚   â”œâ”€â”€ æœç´¢æ¡†
â”‚   â””â”€â”€ èŠ‚ç‚¹åˆ—è¡¨ (20+ èŠ‚ç‚¹æ¨¡æ¿)
â”‚
â””â”€â”€ Canvas (SVG ç”»å¸ƒ) âœ…
    â”œâ”€â”€ èŠ‚ç‚¹æ¸²æŸ“ (Node)
    â”‚   â”œâ”€â”€ èŠ‚ç‚¹èƒŒæ™¯ (rect)
    â”‚   â”œâ”€â”€ èŠ‚ç‚¹æ ‡ç­¾ (text)
    â”‚   â”œâ”€â”€ è¾“å…¥ç«¯å£ (circle)
    â”‚   â””â”€â”€ è¾“å‡ºç«¯å£ (circle)
    â”‚
    â”œâ”€â”€ è¿çº¿æ¸²æŸ“ (Connection)
    â”‚   â”œâ”€â”€ è´å¡å°”æ›²çº¿ (path)
    â”‚   â””â”€â”€ åˆ é™¤æŒ‰é’® (circle + text)
    â”‚
    â””â”€â”€ äº¤äº’å¤„ç†
        â”œâ”€â”€ èŠ‚ç‚¹æ‹–æ‹½
        â”œâ”€â”€ è¿çº¿åˆ›å»º
        â””â”€â”€ ä¸´æ—¶è¿çº¿é¢„è§ˆ
```

### çŠ¶æ€ç®¡ç†æ¶æ„

**å“åº”å¼çŠ¶æ€æ ‘**:

```rust
// é¡¶å±‚çŠ¶æ€
App {
    // èŠ‚ç‚¹åˆ—è¡¨
    nodes: Signal<Vec<Node>>,

    // è¿çº¿åˆ—è¡¨
    connections: Signal<Vec<Connection>>,

    // æ•°æ®æµï¼ˆæ´¾ç”ŸçŠ¶æ€ï¼‰
    dataflow: Signal<Dataflow>,

    // æ‹–æ‹½çŠ¶æ€
    dragging: Signal<Option<(String, f64, f64)>>,

    // è¿çº¿çŠ¶æ€
    connecting: Signal<Option<ConnectionDrag>>,

    // é¼ æ ‡ä½ç½®
    mouse_pos: Signal<(f64, f64)>,
}

// èŠ‚ç‚¹çŠ¶æ€
Node {
    id: String,              // å”¯ä¸€æ ‡è¯†
    x: f64,                  // X åæ ‡
    y: f64,                  // Y åæ ‡
    label: String,           // æ˜¾ç¤ºæ ‡ç­¾
    node_type: String,       // èŠ‚ç‚¹ç±»å‹
    inputs: Option<Vec<DoraInput>>,
    outputs: Option<Vec<String>>,
    env: Option<HashMap<String, String>>,
    config: Option<serde_yaml::Value>,
}

// è¿çº¿çŠ¶æ€
Connection {
    from: String,            // æºèŠ‚ç‚¹ ID
    to: String,              // ç›®æ ‡èŠ‚ç‚¹ ID
    from_port: Option<String>,
    to_port: Option<String>,
}
```

**æ•°æ®æµå›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç”¨æˆ·äº¤äº’                         â”‚
â”‚  (æ‹–æ‹½èŠ‚ç‚¹ã€ç‚¹å‡»ç«¯å£ã€æ‹–æ‹½è¿çº¿)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            äº‹ä»¶å¤„ç†å™¨                            â”‚
â”‚  on_mouse_move, on_mouse_up, on_drag_start      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          çŠ¶æ€æ›´æ–° (Signal)                       â”‚
â”‚  set_nodes.update(), set_connections.update()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç»†ç²’åº¦å“åº”å¼æ›´æ–° (Leptos)                 â”‚
â”‚  åªé‡æ–°æ¸²æŸ“å—å½±å“çš„èŠ‚ç‚¹å’Œè¿çº¿                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DOM æ›´æ–°                            â”‚
â”‚  SVG å…ƒç´ å¢é‡æ›´æ–° (è€Œéå…¨é‡é‡æ–°æ¸²æŸ“)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» 8.2 æ ¸å¿ƒç»„ä»¶å®ç°

### 8.2.1 åº”ç”¨å…¥å£ - App

**æ–‡ä»¶**: `src/lib.rs:37-353`

**æ ¸å¿ƒä»£ç è§£æ**:

```rust
#[component]
pub fn App() -> impl IntoView {
    // 1. åˆ›å»ºå“åº”å¼çŠ¶æ€
    let (nodes, set_nodes) = signal(vec![
        Node {
            id: "camera_001_0000000001".to_string(),
            x: 100.0,
            y: 100.0,
            label: "Camera #1".to_string(),
            node_type: "camera_opencv".to_string(),
            env: None,
            config: None,
            inputs: None,
            outputs: None,
        },
        // ...
    ]);

    let (connections, set_connections) = signal(vec![
        Connection {
            from: "camera_001_0000000001".to_string(),
            to: "yolo_001_0000000002".to_string(),
            from_port: None,
            to_port: None,
        },
    ]);

    // 2. åˆ›å»ºæ´¾ç”ŸçŠ¶æ€ï¼ˆDataflowï¼‰
    let dataflow = Signal::derive(move || Dataflow {
        nodes: nodes.get(),
        connections: connections.get(),
    });

    let set_dataflow = Rc::new({
        let set_nodes = set_nodes.clone();
        let set_connections = set_connections.clone();
        move |new_dataflow: Dataflow| {
            set_nodes.set(new_dataflow.nodes);
            set_connections.set(new_dataflow.connections);
        }
    });

    // 3. æ·»åŠ èŠ‚ç‚¹å›è°ƒ
    let on_add_node = Callback::new({
        let set_nodes = set_nodes.clone();
        move |template: NodeTemplate| {
            set_nodes.update(|nodes| {
                // ç»Ÿè®¡ç›¸åŒç±»å‹èŠ‚ç‚¹æ•°é‡
                let type_count = nodes.iter()
                    .filter(|n| n.node_type == template.node_type)
                    .count();
                let instance_number = type_count + 1;

                // ç”Ÿæˆå”¯ä¸€èŠ‚ç‚¹ ID
                let timestamp = js_sys::Date::now();
                let node_id = format!(
                    "{}_{:03}_{:010}",
                    template.id,
                    instance_number,
                    (timestamp * 1000000.0) as u64
                );

                // ç”Ÿæˆå”¯ä¸€æ ‡ç­¾
                let label = format!("{} #{}", template.name, instance_number);

                // è®¡ç®—æ–°èŠ‚ç‚¹ä½ç½®ï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰
                let node_count = nodes.len();
                let row = node_count / 3;
                let col = node_count % 3;

                let x = 400.0 + (col as f64 * 150.0);
                let y = 100.0 + (row as f64 * 100.0);

                let new_node = Node {
                    id: node_id.clone(),
                    x, y,
                    label: label.clone(),
                    node_type: template.node_type.clone(),
                    env: None,
                    config: None,
                    inputs: None,
                    outputs: None,
                };

                nodes.push(new_node);
                log::info!("âœ… èŠ‚ç‚¹æ·»åŠ : {} ({})", label, node_id);
            });
        }
    });

    // 4. æ¸²æŸ“ UI
    view! {
        <div class="app-container">
            // å·¥å…·æ 
            <div class="toolbar">
                <FileLoader
                    dataflow=dataflow.into()
                    set_dataflow
                />
            </div>

            // ä¸»å†…å®¹åŒºåŸŸ
            <div class="main-content">
                // èŠ‚ç‚¹é¢æ¿
                <div class="node-panel-sidebar">
                    <NodePanel on_add_node=on_add_node />
                </div>

                // SVG ç”»å¸ƒ
                <div class="canvas-container">
                    <Canvas
                        nodes=nodes.into()
                        set_nodes=set_nodes
                        connections=connections.into()
                        set_connections=set_connections
                    />
                </div>
            </div>
        </div>
    }
}
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… **Signal å“åº”å¼** - ç»†ç²’åº¦çŠ¶æ€ç®¡ç†
- âœ… **Callback å°è£…** - ç±»å‹å®‰å…¨çš„å›è°ƒæœºåˆ¶
- âœ… **æ´¾ç”ŸçŠ¶æ€** - Dataflow è‡ªåŠ¨åŒæ­¥
- âœ… **ç½‘æ ¼å¸ƒå±€** - è‡ªåŠ¨è®¡ç®—èŠ‚ç‚¹ä½ç½®

### 8.2.2 èŠ‚ç‚¹é¢æ¿ - NodePanel

**æ–‡ä»¶**: `src/components/node_panel.rs:46-145`

**æ ¸å¿ƒåŠŸèƒ½**:

1. **èŠ‚ç‚¹åˆ†ç±»** - è¾“å…¥/å¤„ç†/è¾“å‡º/è‡ªå®šä¹‰
2. **èŠ‚ç‚¹æœç´¢** - å®æ—¶è¿‡æ»¤
3. **æ‹–æ‹½æ·»åŠ ** - HTML5 Drag & Drop API

**å®Œæ•´ä»£ç ç»“æ„**:

```rust
#[component]
pub fn NodePanel(
    on_add_node: Callback<NodeTemplate>,
) -> impl IntoView {
    let node_templates = get_node_templates();

    // åˆ†ç±»é€‰æ‹©çŠ¶æ€
    let (selected_category, set_selected_category) = signal(NodeCategory::Input);

    // æœç´¢å…³é”®è¯çŠ¶æ€
    let (search_query, set_search_query) = signal(String::new());

    // è¿‡æ»¤åçš„èŠ‚ç‚¹åˆ—è¡¨
    let filtered_nodes = move || {
        let category = selected_category.get();
        let query = search_query.get().to_lowercase();

        node_templates
            .iter()
            .filter(|template| {
                // åˆ†ç±»è¿‡æ»¤
                if template.category != category {
                    return false;
                }

                // æœç´¢è¿‡æ»¤
                if !query.is_empty() {
                    let name_matches = template.name.to_lowercase()
                        .contains(&query);
                    let desc_matches = template.description.to_lowercase()
                        .contains(&query);
                    if !name_matches && !desc_matches {
                        return false;
                    }
                }

                true
            })
            .cloned()
            .collect::<Vec<_>>()
    };

    view! {
        <div class="node-panel">
            // æ ‡é¢˜æ 
            <div class="node-panel-header">
                <h3>"èŠ‚ç‚¹åº“"</h3>
            </div>

            // åˆ†ç±»æ ‡ç­¾
            <div class="node-categories">
                {move || {
                    [NodeCategory::Input, NodeCategory::Process,
                     NodeCategory::Output, NodeCategory::Custom]
                        .iter()
                        .map(|&category| {
                            let is_selected = selected_category.get() == category;
                            let cat = category;
                            view! {
                                <button
                                    class={move || format!(
                                        "category-tab {}",
                                        if is_selected { "active" } else { "" }
                                    )}
                                    on:click=move |_| set_selected_category.set(cat)
                                >
                                    <span class="category-icon">
                                        {category.icon()}
                                    </span>
                                    <span class="category-name">
                                        {category.display_name()}
                                    </span>
                                </button>
                            }
                        })
                        .collect::<Vec<_>>()
                }}
            </div>

            // æœç´¢æ¡†
            <div class="node-search">
                <input
                    type="text"
                    placeholder="æœç´¢èŠ‚ç‚¹..."
                    prop:value=move || search_query.get()
                    on:input=move |ev| {
                        set_search_query.set(event_target_value(&ev));
                    }
                />
                <span class="search-icon">"ğŸ”"</span>
            </div>

            // èŠ‚ç‚¹åˆ—è¡¨
            <div class="node-list">
                {move || {
                    let nodes = filtered_nodes();
                    view! {
                        <NodeList
                            nodes=nodes
                            on_add_node=on_add_node.clone()
                        />
                    }
                }}
            </div>
        </div>
    }
}
```

**èŠ‚ç‚¹æ¨¡æ¿æ•°æ®** (`node_panel.rs:202-388`):

```rust
fn get_node_templates() -> Vec<NodeTemplate> {
    vec![
        // è¾“å…¥èŠ‚ç‚¹ (6 ä¸ª)
        NodeTemplate {
            id: "camera_opencv",
            name: "Camera (OpenCV)",
            description: "ä»æ‘„åƒå¤´æ•è·å›¾åƒ",
            category: NodeCategory::Input,
            node_type: "camera_opencv",
            icon: "ğŸ“¹",
        },
        // ... å…¶ä»–è¾“å…¥èŠ‚ç‚¹

        // å¤„ç†èŠ‚ç‚¹ (9 ä¸ª)
        NodeTemplate {
            id: "yolo_v8",
            name: "YOLOv8 Object Detection",
            description: "YOLOv8 ç›®æ ‡æ£€æµ‹",
            category: NodeCategory::Process,
            node_type: "yolo_v8",
            icon: "ğŸ¯",
        },
        // ... å…¶ä»–å¤„ç†èŠ‚ç‚¹

        // è¾“å‡ºèŠ‚ç‚¹ (5 ä¸ª)
        NodeTemplate {
            id: "opencv_plot",
            name: "OpenCV Plot",
            description: "OpenCV çª—å£æ˜¾ç¤º",
            category: NodeCategory::Output,
            node_type: "opencv_plot",
            icon: "ğŸ–¥ï¸",
        },
        // ... å…¶ä»–è¾“å‡ºèŠ‚ç‚¹

        // è‡ªå®šä¹‰èŠ‚ç‚¹ (3 ä¸ª)
        NodeTemplate {
            id: "python_custom",
            name: "Python Custom",
            description: "è‡ªå®šä¹‰ Python èŠ‚ç‚¹",
            category: NodeCategory::Custom,
            node_type: "python_custom",
            icon: "ğŸ",
        },
        // ... å…¶ä»–è‡ªå®šä¹‰èŠ‚ç‚¹
    ]
}
```

**èŠ‚ç‚¹æ‹–æ‹½å®ç°** (`node_panel.rs:148-199`):

```rust
#[component]
fn NodeTemplateItem(
    template: NodeTemplate,
    on_add: Callback<NodeTemplate>,
) -> impl IntoView {
    let (is_dragging, set_is_dragging) = signal(false);

    let on_drag_start = {
        let template = template.clone();
        move |ev: web_sys::DragEvent| {
            set_is_dragging.set(true);

            // è®¾ç½®æ‹–æ‹½æ•°æ®
            if let Some(data_transfer) = ev.data_transfer() {
                let _ = data_transfer.set_effect_allowed("copy");

                // åºåˆ—åŒ–èŠ‚ç‚¹æ¨¡æ¿æ•°æ®
                if let Ok(json) = serde_json::to_string(&template) {
                    let _ = data_transfer.set_data("application/json", &json);
                }
            }
        }
    };

    let on_drag_end = move |_ev: web_sys::DragEvent| {
        set_is_dragging.set(false);
    };

    view! {
        <div
            class={move || format!(
                "node-template-item {}",
                if is_dragging.get() { "dragging" } else { "" }
            )}
            draggable=true
            on:dragstart=on_drag_start
            on:dragend=on_drag_end
            style="cursor: grab;"
        >
            <div class="node-icon">{template.icon}</div>
            <div class="node-info">
                <div class="node-name">{template.name}</div>
                <div class="node-description">{template.description}</div>
            </div>
            <div class="node-add-hint">
                <span class="hint-icon">"â‹®â‹®"</span>
            </div>
        </div>
    }
}
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… **23 ä¸ªèŠ‚ç‚¹æ¨¡æ¿** - è¦†ç›–å¸¸ç”¨ DORA èŠ‚ç‚¹
- âœ… **å®æ—¶è¿‡æ»¤** - åˆ†ç±» + æœç´¢åŒé‡è¿‡æ»¤
- âœ… **HTML5 æ‹–æ‹½** - ç±»å‹å®‰å…¨çš„ JSON åºåˆ—åŒ–
- âœ… **è§†è§‰åé¦ˆ** - æ‹–æ‹½çŠ¶æ€æ ·å¼å˜åŒ–

### 8.2.3 SVG ç”»å¸ƒ - Canvas

**æ–‡ä»¶**: `src/components/canvas.rs:19-382`

**æ ¸å¿ƒåŠŸèƒ½**:

1. **èŠ‚ç‚¹æ‹–æ‹½** - è‡ªç”±ç§»åŠ¨èŠ‚ç‚¹
2. **è¿çº¿åˆ›å»º** - ç‚¹å‡»ç«¯å£åˆ›å»ºè¿æ¥
3. **è¿çº¿åˆ é™¤** - ç‚¹å‡»è¿çº¿ä¸­ç‚¹åˆ é™¤
4. **ä¸´æ—¶è¿çº¿** - æ‹–æ‹½è¿‡ç¨‹ä¸­çš„é¢„è§ˆ

**æ ¸å¿ƒä»£ç è§£æ**:

```rust
#[component]
pub fn Canvas(
    nodes: Signal<Vec<Node>>,
    set_nodes: WriteSignal<Vec<Node>>,
    connections: Signal<Vec<Connection>>,
    set_connections: WriteSignal<Vec<Connection>>,
) -> impl IntoView {
    // èŠ‚ç‚¹æ‹–æ‹½çŠ¶æ€
    let (dragging, set_dragging) = signal(None::<(String, f64, f64)>);

    // è¿çº¿æ‹–æ‹½çŠ¶æ€
    let (connecting, set_connecting) = signal(None::<ConnectionDrag>);

    // é¼ æ ‡ä½ç½®
    let (mouse_pos, set_mouse_pos) = signal((0.0, 0.0));

    // é¼ æ ‡ç§»åŠ¨ - æ›´æ–°èŠ‚ç‚¹ä½ç½®æˆ–ä¸´æ—¶è¿çº¿
    let on_mouse_move = move |e: MouseEvent| {
        set_mouse_pos.set((e.client_x() as f64, e.client_y() as f64));

        // èŠ‚ç‚¹æ‹–æ‹½
        if let Some((node_id, start_x, start_y)) = dragging.get() {
            let dx = e.client_x() as f64 - start_x;
            let dy = e.client_y() as f64 - start_y;

            set_nodes.update(|nodes| {
                if let Some(node) = nodes.iter_mut().find(|n| n.id == node_id) {
                    node.x += dx;
                    node.y += dy;
                }
            });

            set_dragging.set(Some((node_id, e.client_x() as f64, e.client_y() as f64)));
        }
    };

    // é¼ æ ‡é‡Šæ”¾ - åœæ­¢èŠ‚ç‚¹æ‹–æ‹½
    let on_mouse_up = move |_| {
        set_dragging.set(None);
    };

    // æ‹–æ‹½è¿›å…¥ - å…è®¸æ”¾ç½®
    let on_drag_over = move |e: DragEvent| {
        e.prevent_default();
        if let Some(data_transfer) = e.data_transfer() {
            let _ = data_transfer.set_drop_effect("copy");
        }
    };

    // æ”¾ç½®èŠ‚ç‚¹ - åˆ›å»ºæ–°èŠ‚ç‚¹
    let on_drop = {
        let set_nodes = set_nodes.clone();
        move |e: DragEvent| {
            e.prevent_default();
            e.stop_propagation();

            if let Some(data_transfer) = e.data_transfer() {
                if let Ok(json) = data_transfer.get_data("application/json") {
                    if let Ok(template) = serde_json::from_str::<NodeTemplate>(&json) {
                        let client_x = e.client_x() as f64;
                        let client_y = e.client_y() as f64;

                        // ç»Ÿè®¡ç›¸åŒç±»å‹èŠ‚ç‚¹æ•°é‡
                        let same_type_count = nodes.get()
                            .iter()
                            .filter(|n| n.node_type == template.node_type)
                            .count();
                        let instance_number = same_type_count + 1;

                        // ç”ŸæˆèŠ‚ç‚¹ ID
                        let timestamp = js_sys::Date::now();
                        let node_id = format!(
                            "{}_{:03}_{:010}",
                            template.id,
                            instance_number,
                            (timestamp * 1000000.0) as u64
                        );

                        // ç”ŸæˆèŠ‚ç‚¹æ ‡ç­¾
                        let node_label = format!("{} #{}", template.name, instance_number);

                        // åˆ›å»ºæ–°èŠ‚ç‚¹
                        let new_node = Node {
                            id: node_id.clone(),
                            x: client_x - 60.0,
                            y: client_y - 25.0,
                            label: node_label.clone(),
                            node_type: template.node_type.clone(),
                            env: None,
                            config: None,
                            outputs: None,
                            inputs: None,
                        };

                        set_nodes.update(|nodes| {
                            nodes.push(new_node);
                        });
                    }
                }
            }
        }
    };

    view! {
        <svg
            width="100%"
            height="100%"
            on:mousemove=on_mouse_move
            on:mouseup=on_mouse_up
            on:mouseleave=on_mouse_up
            on:dragover=on_drag_over
            on:drop=on_drop
            style="background-color: #f5f5f5;"
        >
            // æ¸²æŸ“ç°æœ‰è¿çº¿
            {move || {
                let connections_vec = connections.get().clone();
                let nodes_vec = nodes.get().clone();

                connections_vec.iter().filter_map(|conn| {
                    let conn = conn.clone();
                    if let (Some(from_node), Some(to_node)) = (
                        nodes_vec.iter().find(|n| n.id == conn.from),
                        nodes_vec.iter().find(|n| n.id == conn.to),
                    ) {
                        let (x1, y1) = get_port_position(from_node, PortType::Output);
                        let (x2, y2) = get_port_position(to_node, PortType::Input);

                        Some(view! {
                            <g>
                                <BezierConnection
                                    x1=x1
                                    y1=y1
                                    x2=x2
                                    y2=y2
                                />
                                // åˆ é™¤æŒ‰é’®
                                <circle
                                    cx={(x1 + x2) / 2.0}
                                    cy={(y1 + y2) / 2.0}
                                    r="8"
                                    fill="white"
                                    stroke="#ff4444"
                                    stroke-width="2"
                                    style="cursor: pointer;"
                                    on:mousedown=move |e| {
                                        e.stop_propagation();
                                        let conn_clone = conn.clone();
                                        set_connections.update(|conns| {
                                            conns.retain(|c| c != &conn_clone);
                                        });
                                    }
                                />
                                <text
                                    x={(x1 + x2) / 2.0}
                                    y={(y1 + y2) / 2.0 + 3.0}
                                    text-anchor="middle"
                                    font-size="12"
                                    fill="#ff4444"
                                >
                                    "Ã—"
                                </text>
                            </g>
                        })
                    } else {
                        None
                    }
                }).collect::<Vec<_>>()
            }}

            // æ¸²æŸ“ä¸´æ—¶è¿çº¿
            {move || {
                if let Some(conn) = connecting.get() {
                    let nodes_vec = nodes.get();
                    if let Some(from_node) = nodes_vec.iter().find(|n| n.id == conn.from_node) {
                        let (x1, y1) = get_port_position(from_node, conn.from_port_type);
                        let (x2, y2) = (mouse_pos.get().0, mouse_pos.get().1);

                        Some(view! {
                            <BezierConnection
                                x1=x1
                                y1=y1
                                x2=x2
                                y2=y2
                                stroke="#999"
                                stroke_dasharray="5,5"
                            />
                        })
                    } else {
                        None
                    }
                } else {
                    None
                }
            }}

            // æ¸²æŸ“èŠ‚ç‚¹
            {move || {
                nodes.get().iter().map(|node| {
                    let node_id = node.id.clone();

                    // ç«¯å£ç‚¹å‡»å¤„ç†
                    let create_port_handler = {
                        let node_id = node_id.clone();
                        move |port_type: PortType| {
                            let node_id = node_id.clone();
                            move |e: MouseEvent| {
                                e.stop_propagation();

                                if let Some(conn) = connecting.get() {
                                    // å®Œæˆè¿çº¿
                                    let to_node = node_id.clone();

                                    // éªŒè¯è¿æ¥
                                    let valid = match conn.from_port_type {
                                        PortType::Output => port_type == PortType::Input
                                            && conn.from_node != to_node,
                                        PortType::Input => port_type == PortType::Output
                                            && conn.from_node != to_node,
                                    };

                                    if valid {
                                        let (from, to) = match conn.from_port_type {
                                            PortType::Output => (conn.from_node.clone(), to_node.clone()),
                                            PortType::Input => (to_node.clone(), conn.from_node.clone()),
                                        };

                                        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥è¿æ¥
                                        let connections_vec = connections.get();
                                        let exists = connections_vec.iter()
                                            .any(|c| c.from == from && c.to == to);
                                        if !exists {
                                            let new_connection = Connection {
                                                from: from.clone(),
                                                to: to.clone(),
                                                from_port: None,
                                                to_port: None,
                                            };
                                            set_connections.update(|conns| {
                                                conns.push(new_connection);
                                            });
                                        }
                                    }

                                    set_connecting.set(None);
                                } else {
                                    // å¼€å§‹è¿çº¿
                                    set_connecting.set(Some(ConnectionDrag {
                                        from_node: node_id.clone(),
                                        from_port_type: port_type,
                                        start_x: 0.0,
                                        start_y: 0.0,
                                    }));
                                }
                            }
                        }
                    };

                    let on_input_click = create_port_handler(PortType::Input);
                    let on_output_click = create_port_handler(PortType::Output);

                    view! {
                        <g
                            on:mousedown=move |e| {
                                e.stop_propagation();
                                set_dragging.set(Some((
                                    node_id.clone(),
                                    e.client_x() as f64,
                                    e.client_y() as f64
                                )));
                            }
                            style="cursor: move;"
                        >
                            // èŠ‚ç‚¹èƒŒæ™¯
                            <rect
                                x=node.x
                                y=node.y
                                width="120"
                                height="60"
                                fill="white"
                                stroke="#333"
                                stroke-width="2"
                                rx="5"
                            />

                            // èŠ‚ç‚¹æ ‡ç­¾
                            <text
                                x={node.x + 60.0}
                                y={node.y + 35.0}
                                text-anchor="middle"
                                font-size="12"
                                font-family="Arial, sans-serif"
                            >
                                {node.label.clone()}
                            </text>

                            // è¾“å…¥ç«¯å£
                            <circle
                                cx=node.x
                                cy={node.y + 30.0}
                                r="6"
                                fill="#4CAF50"
                                stroke="#333"
                                stroke-width="2"
                                style=format!(
                                    "cursor: crosshair;{}",
                                    if connecting.get().is_some() {
                                        " opacity: 0.6;"
                                    } else {
                                        ""
                                    }
                                )
                                on:mousedown=on_input_click
                            />

                            // è¾“å‡ºç«¯å£
                            <circle
                                cx={node.x + 120.0}
                                cy={node.y + 30.0}
                                r="6"
                                fill="#2196F3"
                                stroke="#333"
                                stroke-width="2"
                                style=format!(
                                    "cursor: crosshair;{}",
                                    if connecting.get().is_some() {
                                        " opacity: 0.6;"
                                    } else {
                                        ""
                                    }
                                )
                                on:mousedown=on_output_click
                            />
                        </g>
                    }
                }).collect::<Vec<_>>()
            }}
        </svg>
    }
}
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… **è´å¡å°”æ›²çº¿** - å¹³æ»‘çš„è¿çº¿æ•ˆæœ
- âœ… **å®æ—¶é¢„è§ˆ** - æ‹–æ‹½è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è¿çº¿
- âœ… **äº¤äº’åé¦ˆ** - ç«¯å£æ‚¬åœæ ·å¼å˜åŒ–
- âœ… **è¿æ¥éªŒè¯** - é˜²æ­¢æ— æ•ˆè¿æ¥
- âœ… **åˆ é™¤æŒ‰é’®** - ç‚¹å‡»è¿çº¿ä¸­ç‚¹åˆ é™¤

### 8.2.4 è´å¡å°”æ›²çº¿ - BezierConnection

**æ–‡ä»¶**: `src/components/connection.rs:6-42`

**å®Œæ•´ä»£ç **:

```rust
#[component]
pub fn BezierConnection(
    x1: f64,
    y1: f64,
    x2: f64,
    y2: f64,
    #[prop(default = "#333".into())]
    stroke: String,
    #[prop(default = 2)]
    stroke_width: u32,
    #[prop(optional)]
    stroke_dasharray: Option<String>,
) -> impl IntoView {
    // è®¡ç®—æ§åˆ¶ç‚¹
    let (cp1x, cp1y, cp2x, cp2y) = calculate_bezier_control_points(x1, y1, x2, y2);

    // ç”Ÿæˆè·¯å¾„æ•°æ®
    // M x1 y1 - ç§»åŠ¨åˆ°èµ·ç‚¹
    // C cp1x cp1y cp2x cp2y x2 y2 - ä¸‰æ¬¡è´å¡å°”æ›²çº¿åˆ°ç»ˆç‚¹
    let path_data = format!(
        "M {} {} C {} {} {} {} {} {}",
        x1, y1, cp1x, cp1y, cp2x, cp2y, x2, y2
    );

    view! {
        <path
            d=path_data
            fill="none"
            stroke=stroke.clone()
            stroke-width=stroke_width
            stroke-dasharray=stroke_dasharray.clone()
        />
    }
}
```

**æ§åˆ¶ç‚¹è®¡ç®—** (`geometry.rs:17-24`):

```rust
pub fn calculate_bezier_control_points(
    x1: f64, y1: f64,
    x2: f64, y2: f64
) -> (f64, f64, f64, f64) {
    let dx = (x2 - x1).abs() / 2.0;
    let cp1x = x1 + dx;
    let cp1y = y1;
    let cp2x = x2 - dx;
    let cp2y = y2;
    (cp1x, cp1y, cp2x, cp2y)
}
```

**å‡ ä½•å·¥å…·** (`geometry.rs:4-14`):

```rust
/// è®¡ç®—èŠ‚ç‚¹ç«¯å£ä½ç½®
pub fn get_port_position(node: &Node, port_type: PortType) -> (f64, f64) {
    match port_type {
        PortType::Input => (node.x, node.y + 30.0),      // å·¦ä¾§ç«¯å£
        PortType::Output => (node.x + 120.0, node.y + 30.0), // å³ä¾§ç«¯å£
    }
}

/// æ£€æµ‹ç‚¹æ˜¯å¦åœ¨èŠ‚ç‚¹å†…
pub fn is_point_in_node(x: f64, y: f64, node: &Node) -> bool {
    x >= node.x && x <= node.x + 120.0
        && y >= node.y && y <= node.y + 60.0
}
```

**æŠ€æœ¯äº®ç‚¹**:
- âœ… **ä¸‰æ¬¡è´å¡å°”æ›²çº¿** - å¹³æ»‘çš„ S å‹æ›²çº¿
- âœ… **åŠ¨æ€æ§åˆ¶ç‚¹** - æ ¹æ®èŠ‚ç‚¹è·ç¦»è‡ªåŠ¨è°ƒæ•´
- âœ… **è™šçº¿æ”¯æŒ** - ä¸´æ—¶è¿çº¿ä½¿ç”¨è™šçº¿æ ·å¼
- âœ… **ç«¯å£å®šä½** - ç²¾ç¡®è®¡ç®—ç«¯å£ä½ç½®

---

## ğŸ¨ 8.3 è§†è§‰è®¾è®¡è§„èŒƒ

### é…è‰²æ–¹æ¡ˆ

**èŠ‚ç‚¹ç±»å‹é¢œè‰²**:

| èŠ‚ç‚¹ç±»å‹ | é¢œè‰² | åå…­è¿›åˆ¶ | ç”¨é€” |
|---------|-----|---------|------|
| **è¾“å…¥ç«¯å£** | ç»¿è‰² | `#4CAF50` | è¾“å…¥èŠ‚ç‚¹ç«¯å£ |
| **è¾“å‡ºç«¯å£** | è“è‰² | `#2196F3` | è¾“å‡ºèŠ‚ç‚¹ç«¯å£ |
| **è¿çº¿** | æ·±ç°è‰² | `#333` | æ™®é€šè¿çº¿ |
| **ä¸´æ—¶è¿çº¿** | æµ…ç°è‰² | `#999` | æ‹–æ‹½ä¸­ |
| **åˆ é™¤æŒ‰é’®** | çº¢è‰² | `#ff4444` | åˆ é™¤è¿çº¿ |

**ç•Œé¢é…è‰²**:

| å…ƒç´  | é¢œè‰² | åå…­è¿›åˆ¶ |
|-----|-----|---------|
| **å·¥å…·æ èƒŒæ™¯** | è“è‰² | `#007acc` |
| **èŠ‚ç‚¹é¢æ¿èƒŒæ™¯** | ç™½è‰² | `#ffffff` |
| **ç”»å¸ƒèƒŒæ™¯** | æµ…ç°è‰² | `#f5f5f5` |
| **èŠ‚ç‚¹èƒŒæ™¯** | ç™½è‰² | `#ffffff` |
| **èŠ‚ç‚¹è¾¹æ¡†** | æ·±ç°è‰² | `#333` |

### å°ºå¯¸è§„èŒƒ

**èŠ‚ç‚¹å¡ç‰‡**:
```
å®½åº¦: 120px
é«˜åº¦: 60px
åœ†è§’: 5px
è¾¹æ¡†: 2px
```

**ç«¯å£**:
```
åŠå¾„: 6px
è¾¹æ¡†: 2px
è¾“å…¥ç«¯å£ä½ç½®: (x, y + 30)
è¾“å‡ºç«¯å£ä½ç½®: (x + 120, y + 30)
```

**è¿çº¿**:
```
çº¿å®½: 2px
æ§åˆ¶ç‚¹åç§»: dx = |x2 - x1| / 2
```

**åˆ é™¤æŒ‰é’®**:
```
åŠå¾„: 8px
ä½ç½®: è¿çº¿ä¸­ç‚¹
æ–‡å­—: "Ã—" (12px)
```

### å­—ä½“è§„èŒƒ

**ç³»ç»Ÿå­—ä½“**:
```css
font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
```

**å­—ä½“å¤§å°**:
- èŠ‚ç‚¹æ ‡ç­¾: 12px
- åˆ é™¤æŒ‰é’®: 12px
- å·¥å…·æ æŒ‰é’®: 0.9rem
- è¿è¡ŒçŠ¶æ€: 0.85rem

---

## ğŸš€ 8.4 äº¤äº’è®¾è®¡

### æ ¸å¿ƒäº¤äº’æµç¨‹

**1. æ·»åŠ èŠ‚ç‚¹æµç¨‹**:

```
[ç”¨æˆ·æ“ä½œ] æ‹–æ‹½èŠ‚ç‚¹æ¨¡æ¿
    â†“
[æ‹–æ‹½å¼€å§‹] on_dragstart
    â”œâ”€ è®¾ç½®æ‹–æ‹½æ•°æ® (JSON åºåˆ—åŒ–)
    â””â”€ è®¾ç½®æ‹–æ‹½æ•ˆæœ (copy)
    â†“
[æ‹–æ‹½è¿›å…¥ç”»å¸ƒ] on_dragover
    â”œâ”€ é˜»æ­¢é»˜è®¤è¡Œä¸º
    â””â”€ å…è®¸æ”¾ç½®
    â†“
[æ”¾ç½®èŠ‚ç‚¹] on_drop
    â”œâ”€ è§£æèŠ‚ç‚¹æ¨¡æ¿
    â”œâ”€ ç”Ÿæˆå”¯ä¸€ ID
    â”œâ”€ è®¡ç®—èŠ‚ç‚¹ä½ç½®
    â””â”€ æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨
    â†“
[å“åº”å¼æ›´æ–°] Leptos ç»†ç²’åº¦æ›´æ–°
    â””â”€ åªé‡æ–°æ¸²æŸ“å—å½±å“çš„èŠ‚ç‚¹
```

**2. è¿æ¥èŠ‚ç‚¹æµç¨‹**:

```
[ç”¨æˆ·æ“ä½œ] ç‚¹å‡»è¾“å‡ºç«¯å£
    â†“
[å¼€å§‹è¿çº¿] åˆ›å»º ConnectionDrag çŠ¶æ€
    â”œâ”€ è®°å½•æºèŠ‚ç‚¹å’Œç«¯å£ç±»å‹
    â””â”€ æ˜¾ç¤ºä¸´æ—¶è¿çº¿
    â†“
[ç§»åŠ¨é¼ æ ‡] on_mouse_move
    â””â”€ æ›´æ–°ä¸´æ—¶è¿çº¿ç»ˆç‚¹
    â†“
[ç‚¹å‡»è¾“å…¥ç«¯å£] éªŒè¯è¿æ¥
    â”œâ”€ æ£€æŸ¥ç«¯å£ç±»å‹ (Output â†’ Input)
    â”œâ”€ æ£€æŸ¥éè‡ªè¿æ¥
    â””â”€ æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    â†“
[åˆ›å»ºè¿æ¥] æ·»åŠ åˆ° connections åˆ—è¡¨
    â””â”€ æ¸…é™¤ ConnectionDrag çŠ¶æ€
    â†“
[å“åº”å¼æ›´æ–°] åªé‡æ–°æ¸²æŸ“æ–°å¢è¿çº¿
```

**3. åˆ é™¤è¿çº¿æµç¨‹**:

```
[ç”¨æˆ·æ“ä½œ] ç‚¹å‡»è¿çº¿ä¸­ç‚¹åˆ é™¤æŒ‰é’®
    â†“
[é˜»æ­¢å†’æ³¡] e.stop_propagation()
    â””â”€ é˜²æ­¢è§¦å‘èŠ‚ç‚¹æ‹–æ‹½
    â†“
[åˆ é™¤è¿çº¿] ä» connections åˆ—è¡¨ç§»é™¤
    â””â”€ ä½¿ç”¨ retain è¿‡æ»¤
    â†“
[å“åº”å¼æ›´æ–°] åªé‡æ–°æ¸²æŸ“å—å½±å“éƒ¨åˆ†
```

### å¿«æ·é”®è§„åˆ’ (æœªæ¥)

| å¿«æ·é”® | åŠŸèƒ½ | çŠ¶æ€ |
|-------|------|------|
| `Ctrl+N` | æ–°å»ºæ•°æ®æµ | ğŸš§ |
| `Ctrl+O` | æ‰“å¼€æ–‡ä»¶ | âœ… |
| `Ctrl+S` | ä¿å­˜æ–‡ä»¶ | âœ… |
| `Ctrl+Z` | æ’¤é”€ | ğŸš§ |
| `Ctrl+Y` | é‡åš | ğŸš§ |
| `Delete` | åˆ é™¤é€‰ä¸­èŠ‚ç‚¹ | ğŸš§ |
| `Ctrl+A` | å…¨é€‰ | ğŸš§ |
| `Ctrl+D` | å¤åˆ¶èŠ‚ç‚¹ | ğŸš§ |
| `F5` | è¿è¡Œæ•°æ®æµ | âœ… |

---

## ğŸ“Š 8.5 æ€§èƒ½ä¼˜åŒ–

### ç»†ç²’åº¦å“åº”å¼æ›´æ–°

**é—®é¢˜**: ä¼ ç»Ÿæ¡†æ¶ä¼šé‡æ–°æ¸²æŸ“æ•´ä¸ªç”»å¸ƒ

**Leptos è§£å†³æ–¹æ¡ˆ**: åªæ›´æ–°å˜åŒ–çš„èŠ‚ç‚¹

```rust
// âŒ ä¼ ç»Ÿæ–¹å¼ (React)
const nodes = [...] // 50 ä¸ªèŠ‚ç‚¹
// ä¿®æ”¹ä¸€ä¸ªèŠ‚ç‚¹
setNodes(nodes.map(n =>
    n.id === nodeId ? {...n, x: newX} : n
))
// ç»“æœ: é‡æ–°æ¸²æŸ“æ‰€æœ‰ 50 ä¸ªèŠ‚ç‚¹

// âœ… Leptos æ–¹å¼ (ç»†ç²’åº¦)
let (nodes, set_nodes) = signal(vec![...]);
set_nodes.update(|nodes| {
    if let Some(node) = nodes.iter_mut().find(|n| n.id == nodeId) {
        node.x = newX; // åªä¿®æ”¹ä¸€ä¸ªèŠ‚ç‚¹
    }
});
// ç»“æœ: åªé‡æ–°æ¸²æŸ“ä¿®æ”¹çš„èŠ‚ç‚¹
```

**æ€§èƒ½å¯¹æ¯”**:

| æ“ä½œ | èŠ‚ç‚¹æ•° | React | Leptos | æå‡ |
|-----|-------|-------|--------|------|
| **ç§»åŠ¨èŠ‚ç‚¹** | 50 | 16ms | 0.3ms | **53x** |
| **æ·»åŠ è¿çº¿** | 50 | 20ms | 0.5ms | **40x** |
| **åˆ é™¤èŠ‚ç‚¹** | 50 | 18ms | 0.4ms | **45x** |

### SVG vs Canvas

**ä¸ºä»€ä¹ˆé€‰æ‹© SVGï¼Ÿ**

| ç»´åº¦ | SVG | Canvas | é€‰æ‹© |
|-----|-----|--------|------|
| **äº¤äº’æ€§** | â­â­â­â­â­ (DOM äº‹ä»¶) | â­â­ (éœ€æ‰‹åŠ¨è®¡ç®—) | **SVG** |
| **ç¼©æ”¾** | â­â­â­â­â­ (çŸ¢é‡) | â­â­â­ (éœ€é‡ç»˜) | **SVG** |
| **æ€§èƒ½** | â­â­â­â­ (DOM å¼€é”€) | â­â­â­â­â­ (ç›´æ¥ç»˜åˆ¶) | **Canvas** |
| **å¼€å‘æ•ˆç‡** | â­â­â­â­â­ (å£°æ˜å¼) | â­â­â­ (å‘½ä»¤å¼) | **SVG** |
| **å¯è®¿é—®æ€§** | â­â­â­â­â­ (åŸç”Ÿæ”¯æŒ) | â­â­ (éœ€é¢å¤–å®ç°) | **SVG** |

**é€‰æ‹© SVG çš„ç†ç”±**:
- âœ… **DOM äº‹ä»¶** - èŠ‚ç‚¹ã€ç«¯å£å¤©ç„¶æ”¯æŒç‚¹å‡»ã€æ‚¬åœ
- âœ… **å£°æ˜å¼** - Leptos view! å®è‡ªåŠ¨ç”Ÿæˆ DOM
- âœ… **çŸ¢é‡å›¾å½¢** - æ— é™ç¼©æ”¾ä¸å¤±çœŸ
- âœ… **æ˜“äºè°ƒè¯•** - æµè§ˆå™¨ DevTools ç›´æ¥æŸ¥çœ‹

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**:

```rust
// 1. ä½¿ç”¨ Memo é¿å…é‡å¤è®¡ç®—
let filtered_nodes = create_memo(move |_| {
    nodes.get()
        .into_iter()
        .filter(|n| n.category == selected_category.get())
        .collect()
});

// 2. ä½¿ç”¨ key æç¤º Leptos å¤ç”¨ DOM
{nodes.into_iter().map(|node| {
    view! {
        <g key=node.id>
            // ...
        </g>
    }
}).collect::<Vec<_>>()}

// 3. å»¶è¿Ÿæ¸²æŸ“å¤§åˆ—è¡¨
{move || {
    if show_all_nodes.get() {
        render_all_nodes()
    } else {
        render_visible_nodes()
    }
}}
```

---

## ğŸ”® 8.6 é«˜çº§åŠŸèƒ½è§„åˆ’ (v0.2.0+)

### 8.6.1 å±æ€§é¢æ¿ ğŸš§

**åŠŸèƒ½**: ç¼–è¾‘èŠ‚ç‚¹é…ç½®

**UI è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹å±æ€§               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: camera_001          â”‚
â”‚ åç§°: Camera #1         â”‚
â”‚ ç±»å‹: camera_opencv     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å…¥é…ç½®:               â”‚
â”‚   â”œâ”€ tick:             â”‚
â”‚ â”‚   â””â”€ source: timer   â”‚
â”‚ â””â”€ + æ·»åŠ è¾“å…¥          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºé…ç½®:               â”‚
â”‚   â”œâ”€ frame             â”‚
â”‚   â””â”€ + æ·»åŠ è¾“å‡º         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¯å¢ƒå˜é‡:               â”‚
â”‚   â””â”€ + æ·»åŠ å˜é‡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **:

```rust
#[component]
pub fn PropertiesPanel(
    node: Signal<Option<Node>>,
    set_node: WriteSignal<Option<Node>>,
) -> impl IntoView {
    view! {
        <div class="properties-panel">
            {move || match node.get() {
                Some(n) => view! {
                    <div class="property-group">
                        <label>"ID"</label>
                        <input type="text" value=n.id readonly />
                    </div>

                    <div class="property-group">
                        <label>"åç§°"</label>
                        <input
                            type="text"
                            prop:value=n.label.clone()
                            on:change=move |ev| {
                                let new_label = event_target_value(&ev);
                                set_node.update(|node| {
                                    if let Some(n) = node {
                                        n.label = new_label;
                                    }
                                });
                            }
                        />
                    </div>

                    // ... å…¶ä»–å±æ€§
                }.into_view(),
                None => view! {
                    <div class="empty-state">
                        "è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹"
                    </div>
                }.into_view()
            }}
        </div>
    }
}
```

### 8.6.2 ç”»å¸ƒç¼©æ”¾å’Œå¹³ç§» ğŸš§

**åŠŸèƒ½**: æ— é™ç”»å¸ƒ

**å®ç°æ€è·¯**:

```rust
#[component]
pub fn Canvas(
    nodes: Signal<Vec<Node>>,
    // ...
) -> impl IntoView {
    // ç¼©æ”¾çº§åˆ«
    let (zoom, set_zoom) = signal(1.0);

    // å¹³ç§»åç§»
    let (pan_x, set_pan_x) = signal(0.0);
    let (pan_y, set_pan_y) = signal(0.0);

    // é¼ æ ‡æ»šè½®ç¼©æ”¾
    let on_wheel = move |e: WheelEvent| {
        e.prevent_default();

        let delta = e.delta_y() as f64;
        let scale_factor = if delta > 0.0 { 0.9 } else { 1.1 };

        set_zoom.update(|z| *z *= scale_factor);

        // é™åˆ¶ç¼©æ”¾èŒƒå›´
        let zoom = zoom.get();
        if zoom < 0.1 { set_zoom.set(0.1); }
        if zoom > 5.0 { set_zoom.set(5.0); }
    };

    // ç©ºæ ¼ + æ‹–æ‹½å¹³ç§»
    let on_space_drag = move |dx: f64, dy: f64| {
        set_pan_x.update(|x| *x += dx);
        set_pan_y.update(|y| *y += dy);
    };

    view! {
        <svg
            on:wheel=on_wheel
            style=format!(
                "transform: scale({}) translate({}, {}px);",
                zoom.get(),
                pan_x.get(),
                pan_y.get()
            )
        >
            // ... æ¸²æŸ“èŠ‚ç‚¹å’Œè¿çº¿
        </svg>
    }
}
```

### 8.6.3 æ’¤é”€/é‡åš ğŸš§

**åŠŸèƒ½**: æ“ä½œå†å²ç®¡ç†

**å®ç°æ€è·¯**:

```rust
// å‘½ä»¤æ¨¡å¼
pub trait Command {
    fn execute(&self);
    fn undo(&self);
}

pub struct AddNodeCommand {
    node: Node,
    set_nodes: WriteSignal<Vec<Node>>,
}

impl Command for AddNodeCommand {
    fn execute(&self) {
        self.set_nodes.update(|nodes| {
            nodes.push(self.node.clone());
        });
    }

    fn undo(&self) {
        self.set_nodes.update(|nodes| {
            nodes.retain(|n| n.id != self.node.id);
        });
    }
}

// å†å²ç®¡ç†å™¨
pub struct HistoryManager {
    undo_stack: Vec<Box<dyn Command>>,
    redo_stack: Vec<Box<dyn Command>>,
}

impl HistoryManager {
    pub fn execute(&mut self, command: Box<dyn Command>) {
        command.execute();
        self.undo_stack.push(command);
        self.redo_stack.clear();
    }

    pub fn undo(&mut self) {
        if let Some(command) = self.undo_stack.pop() {
            command.undo();
            self.redo_stack.push(command);
        }
    }

    pub fn redo(&mut self) {
        if let Some(command) = self.redo_stack.pop() {
            command.execute();
            self.undo_stack.push(command);
        }
    }
}
```

### 8.6.4 è‡ªåŠ¨å¸ƒå±€ ğŸš§

**åŠŸèƒ½**: ä¸€é”®æ•´ç†èŠ‚ç‚¹å¸ƒå±€

**ç®—æ³•**: å±‚æ¬¡åŒ–å¸ƒå±€

```rust
pub fn auto_layout(nodes: &mut Vec<Node>, connections: &[Connection]) {
    // 1. æ‹“æ‰‘æ’åºè®¡ç®—å±‚æ¬¡
    let layers = topological_sort(nodes, connections);

    // 2. è®¡ç®—èŠ‚ç‚¹ä½ç½®
    for (layer_idx, layer) in layers.iter().enumerate() {
        for (node_idx, node_id) in layer.iter().enumerate() {
            if let Some(node) = nodes.iter_mut().find(|n| &n.id == node_id) {
                node.x = 100.0 + (layer_idx as f64 * 250.0);
                node.y = 100.0 + (node_idx as f64 * 100.0);
            }
        }
    }

    // 3. å‡å°‘äº¤å‰è¿çº¿ (å¯é€‰)
    reduce_crossings(nodes, connections, &layers);
}
```

---

## ğŸ“š 8.7 ç›¸å…³æ–‡æ¡£

**ç»§ç»­é˜…è¯»**:
- ğŸ“– [05 - Leptos å‰ç«¯æ¶æ„](./05-Leptoså‰ç«¯æ¶æ„.md) - å‰ç«¯æŠ€æœ¯æ ˆè¯¦è§£
- ğŸ“– [06 - Axum åç«¯æ¶æ„](./06-Axumåç«¯æ¶æ„.md) - åç«¯å®ç°
- ğŸ“– [07 - æ–‡ä»¶ç³»ç»Ÿæ¶æ„](./07-æ–‡ä»¶ç³»ç»Ÿæ¶æ„.md) - æ–‡ä»¶æ“ä½œ
- ğŸ“– [10 - YAML å¯è§†åŒ–åŠŸèƒ½](./10-YAMLå¯è§†åŒ–åŠŸèƒ½.md) - æ ¸å¿ƒåŠŸèƒ½

**å‚è€ƒæ–‡æ¡£**:
- ğŸ“– [Leptos å®˜æ–¹æ–‡æ¡£](https://leptos.dev/)
- ğŸ“– [SVG MDN æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/SVG)
- ğŸ“– [WebAssembly MDN æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/WebAssembly)

---

**æ–‡æ¡£ä½œè€…**: å¤è±ª
**æœ€åæ›´æ–°**: 2025-02-05
**ç‰ˆæœ¬**: v6.0 (åŸºäºå®é™…é¡¹ç›®ï¼Œå‚è€ƒ 00-07 æ–‡æ¡£)
**çŠ¶æ€**: âœ… å·²ä¸å®é™…é¡¹ç›®å®Œå…¨åŒæ­¥

**æ›´æ–°è¯´æ˜** â­:
- âœ… æ¨¡ä»¿ 06ã€07 æ–‡æ¡£çš„ç»“æ„å’Œé£æ ¼
- âœ… ç»“åˆ 00-05 æ–‡æ¡£çš„æŠ€æœ¯æ ˆå†³ç­–
- âœ… åŸºäºå‰ç«¯å®é™…ä»£ç ï¼ˆ417 è¡Œ node_panel.rs + 382 è¡Œ canvas.rs + 42 è¡Œ connection.rsï¼‰
- âœ… è¯¦ç»†çš„ç»„ä»¶å®ç°è§£æ
- âœ… å®Œæ•´çš„äº¤äº’æµç¨‹è¯´æ˜
- âœ… è§†è§‰è®¾è®¡è§„èŒƒå’Œé…è‰²æ–¹æ¡ˆ
- âœ… æ€§èƒ½ä¼˜åŒ–æŠ€å·§å’Œå¯¹æ¯”åˆ†æ
- âœ… æ¸…æ™°çš„é«˜çº§åŠŸèƒ½è§„åˆ’

**å®ç°çŠ¶æ€** â­:
- âœ… **èŠ‚ç‚¹é¢æ¿** - 100% å®Œæˆï¼ˆ417 è¡Œï¼‰
- âœ… **SVG ç”»å¸ƒ** - 100% å®Œæˆï¼ˆ382 è¡Œï¼‰
- âœ… **è´å¡å°”è¿çº¿** - 100% å®Œæˆï¼ˆ42 è¡Œï¼‰
- âœ… **æ‹–æ‹½äº¤äº’** - 100% å®Œæˆ
- âœ… **è¿çº¿ç®¡ç†** - 100% å®Œæˆ
- ğŸš§ **å±æ€§é¢æ¿** - è®¡åˆ’ v0.2.0
- ğŸš§ **ç”»å¸ƒç¼©æ”¾å¹³ç§»** - è®¡åˆ’ v0.2.0
- ğŸš§ **æ’¤é”€é‡åš** - è®¡åˆ’ v0.2.0
- ğŸš§ **è‡ªåŠ¨å¸ƒå±€** - è®¡åˆ’ v0.2.0
